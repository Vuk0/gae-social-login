// Generated by CoffeeScript 1.6.1
(function() {
  var authenticate_user, check_if_blank, login_success, prompt_for_merge, register_user;

  check_if_blank = function(fields) {
    var field, is_blank, _i, _len;
    is_blank = false;
    for (_i = 0, _len = fields.length; _i < _len; _i++) {
      field = fields[_i];
      if ($(field).val() === '') {
        $(field).closest('.control-group').addClass('error');
        is_blank = true;
      } else {
        $(field).closest('.control-group').removeClass('error');
      }
    }
    return is_blank;
  };

  $("#register").click(function() {
    var person_data;
    if (check_if_blank(['#username', '#new_password', '#confirm_password'])) {
      alert('Please fill the fields marked in red and try again.');
      return false;
    }
    if ($("#new_password").val() !== $("#confirm_password").val()) {
      alert('Password and Confirm Password do not match.');
      return false;
    }
    person_data = {
      username: $("#username").val(),
      password: $("#new_password").val(),
      first_name: $("#username").val().split('@')[0],
      acq_source: 'email'
    };
    return register_user(person_data);
  });

  register_user = function(person_data) {
    var ajax_params;
    person_data.username = person_data.username.toLowerCase();
    ajax_params = {
      url: "/people/add",
      dataType: "json",
      type: "PUT",
      data: person_data,
      success: function(response) {
        if (response) {
          if (response.success) {
            alert('Registration successful. Click OK to continue ....');
            return login_success(response);
          } else {
            if (response.reason === 'already_exist') {
              return alert("Your account is registered via <span style='text-transform: capitalize;'>" + response.login_type + "</span>.\nPlease log in.");
            } else {
              return alert('Unexpected error. The server says: ' + response.reason);
            }
          }
        } else {
          return alert('There was some error in communication. Please try again later.');
        }
      },
      error: function() {
        return alert('There was some error reaching the server at this time. Please try again later.');
      }
    };
    return $.ajax(ajax_params);
  };

  $("#native_login").click(function() {
    var person_data;
    if (check_if_blank(['#email', '#password'])) {
      alert('Please fill the fields marked in red and try again.');
      return false;
    }
    person_data = {
      username: $("#email").val(),
      password: $("#password").val(),
      login_type: 'email'
    };
    return authenticate_user(person_data);
  });

  authenticate_user = function(person_data) {
    var ajax_params;
    person_data.username = person_data.username.toLowerCase();
    ajax_params = {
      url: '/login',
      dataType: "json",
      data: person_data,
      context: person_data,
      success: function(response) {
        if (response) {
          if (response.success) {
            return login_success(response);
          } else {
            if (response.reason === 'unmatched_password') {
              return alert('Invalid email address or password. Please try again.');
            } else if (response.reason === 'other_login_type') {
              return alert("Your account is registered via <span style='text-transform: capitalize;'>" + response.login_type + "</span>.\nPlease click 'Sign in with Facebook' to log in.");
            } else if (response.reason === 'no_user') {
              return alert("Invalid email address or password.\nIf you do not have an account,\nclick 'Sign up' or 'Sign in with Facebook'");
            } else if (response.reason === 'merge') {
              return prompt_for_merge(response.uid, this);
            }
          }
        } else {
          return alert('There was some error in communication. Please try again later.');
        }
      },
      error: function() {
        return alert('There was some error reaching the server at this time. Please try again later.');
      },
      complete: function() {}
    };
    return $.ajax(ajax_params);
  };

  $("#logout").click(function() {
    var ajax_params;
    ajax_params = {
      url: '/logout',
      dataType: "json",
      data: {
        username: cc_user.email_addr
      },
      success: function(response) {
        if (response && response.success) {
          $.cookie(response.cookie_name, '', {
            path: '/'
          });
          return window.location = window.location;
        }
      }
    };
    return $.ajax(ajax_params);
  });

  prompt_for_merge = function(uid, person_data) {
    $(".modal-body").html($.tmpl($.template('#merge_template'), person_data));
    $("#merging_email").data({
      uid: uid,
      person_data: person_data
    });
    return $("#merging_popup").modal('show');
  };

  $("#merge_logins").click(function() {
    var ajax_params, person_data, uid;
    if (check_if_blank(['#merging_password'])) {
      alert('Please fill the password (marked in red) and try again.');
      return false;
    }
    uid = $("#merging_email").data('uid');
    person_data = $("#merging_email").data('person_data');
    person_data.password = $("#merging_password").val();
    ajax_params = {
      url: "/people/" + uid,
      dataType: "json",
      type: "POST",
      data: person_data,
      success: function(response) {
        if (response) {
          if (response.success) {
            alert('Social login is now enabled for you.');
            return login_success(response);
          } else if (response.reason === 'unmatched_password') {
            return alert('Invalid email address or password. Please try again.');
          } else {
            return alert('There was some error saving the data at this time. Please try again later.');
          }
        } else {
          return alert('There was some error in communication. Please try again later.');
        }
      },
      error: function() {
        return alert('There was some error reaching the server at this time. Please try again later.');
      },
      complete: function() {}
    };
    return $.ajax(ajax_params);
  });

  login_success = function(response) {
    $.cookie(response.cookie_name, response.cookie_value, {
      path: '/'
    });
    return window.location = window.next_url;
  };

  window.authenticate_user = authenticate_user;

}).call(this);
